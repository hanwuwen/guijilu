<!--activity.wxml-->
<view class="container">
  <!-- åŠ è½½ä¸­ -->
  <view wx:if="{{loading}}" class="loading">
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- æ´»åŠ¨è¯¦æƒ… -->
  <view wx:else>
    <!-- æ´»åŠ¨å°é¢ -->
    <image 
      class="activity-cover" 
      src="{{activity.coverImage || 'https://via.placeholder.com/750x400?text=æ´»åŠ¨å°é¢'}}" 
      mode="aspectFill"
    />

    <!-- æ´»åŠ¨åŸºæœ¬ä¿¡æ¯ -->
    <view class="card">
      <text class="activity-title">{{activity.name}}</text>
      <text class="activity-desc">{{activity.description}}</text>
      <view class="activity-info">
        <text class="info-item">ğŸ“ {{activity.city}}</text>
        <text class="info-item">ğŸ‘¥ {{activity.participants || 0}}äººå‚ä¸</text>
        <text class="info-item">â° {{activity.startDate}} - {{activity.endDate}}</text>
      </view>
      <!-- ç­‰çº§æç¤º -->
      <view class="level-tip" wx:if="{{levelInfo}}">
        <view class="level-tip-content">
          <text class="level-tip-icon">{{levelInfo.icon}}</text>
          <text class="level-tip-text">
            æ‚¨å½“å‰ç­‰çº§ï¼š{{levelInfo.name}} Lv{{levelInfo.level}}
            <text wx:if="{{!isParticipant}}" class="level-reward">ï¼ˆå‚ä¸æ´»åŠ¨å¯è·å¾—20ç»éªŒå€¼ï¼‰</text>
            <text wx:else class="level-reward">ï¼ˆå®Œæˆæ‰“å¡å¯è·å¾—10ç»éªŒå€¼/æ¬¡ï¼‰</text>
          </text>
        </view>
      </view>
    </view>

    <!-- æ‰“å¡åœ°ç‚¹åˆ—è¡¨ -->
    <view class="card">
      <text class="section-title">æ‰“å¡åœ°ç‚¹</text>
      <view class="checkpoint-list">
        <block wx:for="{{activity.checkpoints}}" wx:key="index">
          <view class="checkpoint-item" bindtap="goToCheckin" data-index="{{index}}">
            <view class="checkpoint-index">{{index + 1}}</view>
            <view class="checkpoint-info">
              <text class="checkpoint-name">{{item.name}}</text>
              <text class="checkpoint-desc">{{item.description}}</text>
              <text class="checkpoint-location">{{item.location.name}}</text>
            </view>
            <view class="checkpoint-status">
              <text class="status-dot {{userCheckins[index] ? 'completed' : 'pending'}}"></text>
              <text class="status-text">{{userCheckins[index] ? 'å·²æ‰“å¡' : 'æœªæ‰“å¡'}}</text>
            </view>
          </view>
        </block>
      </view>
    </view>

    <!-- è¯„è®ºåŒº -->
    <view class="card">
      <text class="section-title">è¯„è®ºåŒº</text>
      <view class="comments-section">
        <view class="comment-input-section">
          <input class="comment-input" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." bindinput="onCommentInput" value="{{commentContent}}"/>
          <button class="comment-submit-btn" bindtap="submitComment">å‘è¡¨è¯„è®º</button>
        </view>
        <view class="comments-list">
          <block wx:for="{{comments}}" wx:key="index">
            <view class="comment-item">
              <view class="comment-avatar">
                <text class="avatar-text">{{item.userInfo.nickName?.charAt(0) || 'ç”¨'}}</text>
              </view>
              <view class="comment-content">
                <text class="comment-username">{{item.userInfo.nickName || 'ç”¨æˆ·'}}</text>
                <text class="comment-text">{{item.content}}</text>
                <text class="comment-time">{{item.createdAt}}</text>
                <view class="comment-actions">
                  <text class="comment-like" bindtap="likeComment" data-id="{{item._id}}">
                    {{item.liked ? 'â¤ï¸' : 'ğŸ¤'}} {{item.likes || 0}}
                  </text>
                </view>
              </view>
            </view>
          </block>
        </view>
      </view>
    </view>

    <!-- æ´»åŠ¨äºŒç»´ç  -->
    <view class="card">
      <text class="section-title">åˆ†äº«æ´»åŠ¨</text>
      <view class="qrcode-section">
        <image class="qrcode" src="{{qrcode}}" mode="aspectFill" />
        <text class="qrcode-text">æ‰«æäºŒç»´ç åŠ å…¥æ´»åŠ¨</text>
        <button class="share-btn" bindtap="shareActivity">åˆ†äº«ç»™å¥½å‹</button>
      </view>
    </view>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <view class="bottom-bar">
      <button 
        wx:if="{{!isParticipant}}" 
        class="join-btn" 
        bindtap="joinActivity"
      >
        åŠ å…¥æ´»åŠ¨
      </button>
      <view wx:else class="progress-section">
        <text class="progress-text">
          å·²å®Œæˆ {{completedCheckpoints}}/{{activity.checkpoints.length}} ä¸ªæ‰“å¡ç‚¹
        </text>
        <button 
          wx:if="{{completedCheckpoints < activity.checkpoints.length}}" 
          class="checkin-btn" 
          bindtap="goToNextCheckin"
        >
          ç«‹å³æ‰“å¡
        </button>
        <button 
          wx:else 
          class="certificate-btn" 
          bindtap="getCertificate"
        >
          é¢†å–è¯ä¹¦
        </button>
      </view>
    </view>
  </view>
</view>