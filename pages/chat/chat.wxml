<!-- chat.wxml -->
<view class="container">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <view class="header">
    <view class="back-btn" bindtap="goBack">
      <text>â†</text>
    </view>
    <view class="title">
      <text wx:if="{{conversationType === 'single' && otherUserInfo}}">{{otherUserInfo.nickName}}</text>
      <text wx:else>{{conversationName || 'èŠå¤©'}}</text>
    </view>
    <view class="placeholder"></view>
  </view>
  
  <!-- æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view 
    class="message-list" 
    scroll-y 
    bindscrolltolower="scrollToBottom"
    scroll-top="{{scrollTop}}"
  >
    <view wx:if="{{messages.length === 0}}" class="empty-message">
      <text>æš‚æ— æ¶ˆæ¯</text>
    </view>
    <view wx:else>
      <!-- æ¶ˆæ¯é¡¹ -->
      <view 
        wx:for="{{messages}}" 
        wx:key="_id" 
        class="message-item {{messages[index].senderOpenid === openid ? 'my-message' : 'other-message'}}"
      >
        <!-- å¯¹æ–¹æ¶ˆæ¯ -->
        <view wx:if="{{messages[index].senderOpenid !== openid}}" class="message-content">
          <view class="avatar">
            <image src="{{messages[index].senderInfo.avatarUrl || '../../images/default-avatar.png'}}" mode="aspectFill"></image>
          </view>
          <view class="message-bubble left-bubble">
            <text wx:if="{{messages[index].type === 'text'}}" class="message-text">{{messages[index].content}}</text>
            <image wx:else-if="{{messages[index].type === 'image'}}" src="{{messages[index].content}}" mode="aspectFill" class="message-image"></image>
          </view>
        </view>
        
        <!-- æˆ‘çš„æ¶ˆæ¯ -->
        <view wx:else class="message-content right-content">
          <view class="message-bubble right-bubble">
            <text wx:if="{{messages[index].type === 'text'}}" class="message-text">{{messages[index].content}}</text>
            <image wx:else-if="{{messages[index].type === 'image'}}" src="{{messages[index].content}}" mode="aspectFill" class="message-image"></image>
          </view>
          <view class="read-status">
            <text wx:if="{{messages[index].readStatus && messages[index].readStatus[otherUserInfo.openid]}}" class="read">å·²è¯»</text>
            <text wx:else class="unread">æœªè¯»</text>
          </view>
          <view class="avatar">
            <image src="{{userInfo.avatarUrl || '../../images/default-avatar.png'}}" mode="aspectFill"></image>
          </view>
        </view>
        
        <!-- æ¶ˆæ¯æ—¶é—´ -->
        <view class="message-time">
          <text>{{messages[index].createdAt}}</text>
        </view>
      </view>
    </view>
    
    <!-- åŠ è½½æ›´å¤š -->
    <view wx:if="{{loading}}" class="loading-more">
      <text>åŠ è½½ä¸­...</text>
    </view>
  </scroll-view>
  
  <!-- è¾“å…¥åŒºåŸŸ -->
  <view class="input-area">
    <view class="input-tools">
      <button class="tool-btn" bindtap="chooseImage">
        <text class="tool-icon">ğŸ–¼ï¸</text>
      </button>
      <button class="tool-btn" bindtap="showEmojiPanel">
        <text class="tool-icon">ğŸ˜Š</text>
      </button>
    </view>
    <input 
      class="input" 
      placeholder="è¾“å…¥æ¶ˆæ¯..." 
      value="{{inputValue}}" 
      bindinput="inputChange"
    ></input>
    <button class="send-btn" bindtap="sendMessage">å‘é€</button>
  </view>
  
  <!-- è¡¨æƒ…é¢æ¿ -->
  <view wx:if="{{showEmoji}}" class="emoji-panel">
    <view class="emoji-list">
      <view wx:for="{{emojis}}" wx:key="index" class="emoji-item" bindtap="selectEmoji" data-emoji="{{emojis[index]}}">
        <text>{{emojis[index]}}</text>
      </view>
    </view>
  </view>
</view>
