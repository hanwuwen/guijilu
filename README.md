# 城市漫游者 —— 多活动打卡小程序
 

 > 一个支持用户创建、参与和分享城市探索活动的微信小程序。  
 
 > 用户可自定义打卡路线，编辑个人资料，并生成专属成就证书。  


 ## 🌟 功能亮点  


- ✅ 创建自定义打卡活动（最多20个地点）  
- ✅ 扫码加入他人活动，支持多活动并行参与  
- ✅ 个人中心：编辑头像、昵称、签名、城市  
- ✅ 地理位置校验（500米内才可打卡）  
- ✅ 完成活动后生成电子证书，支持保存分享  
- ✅ 全流程基于腾讯云开发，无需服务器运维  
- ✅ 管理员功能：用户举报处理、评论管理、反馈管理  
- ✅ 聊天功能：消息已读/未读状态、实时推送、支持图片和表情  
- ✅ 用户反馈功能：管理员查看反馈，支持未读/已读标记和回复
- ✅ 违规内容检测：自动检测和屏蔽敏感词、个人信息等违规内容  


 ## 🛠️ 部署前准备  


 ### 1. 注册微信小程序  
 - 访问 `https://mp.weixin.qq.com`  
 - 注册 **个人类型** 小程序（免费）  
 - 记录你的 **AppID**  


 ### 2. 开通腾讯云开发  
 - 登录 `https://console.cloud.tencent.com/tcb`  
 - 创建 **按量计费** 环境（免费额度足够个人使用）  
 - 记录 **环境 ID**（如：prod-xxxxx）  


 ## 🖥️ 本地开发步骤


1. 下载并安装 `https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html`  
2. 打开本项目文件夹  
3. 在 `app.js` 中替换 `env` 为你的云开发环境 ID：  
   ```javascript  
   wx.cloud.init({
     env: 'prod-xxxxx', // 替换为你的云开发环境ID
     traceUser: true
   })
   ```  
4. 点击 **编译** 开始本地开发  


 ## 🚀 云环境部署  


1. **云函数上传**：  
   - 右键 `cloudfunctions` 目录  
   - 选择 **上传并部署：云端安装依赖**  
   - 确保以下云函数都已上传：  
     - `getActivityList`：获取活动列表  
     - `createActivity`：创建活动  
     - `getActivity`：获取活动详情  
     - `joinActivity`：加入活动  
     - `submitCheckin`：提交打卡记录  
     - `generateQRCode`：生成活动二维码  
     - `getUserInfo`：获取用户信息  
     - `updateUserInfo`：更新用户信息  
     - `saveCertificate`：保存证书记录  
     - `getUserReports`：获取用户举报列表  
     - `handleUserReport`：处理用户举报  
     - `getComments`：获取评论列表  
     - `deleteComment`：删除评论  
     - `sendMessage`：发送消息  
     - `getMessages`：获取消息列表  
     - `submitFeedback`：提交用户反馈  
     - `manageFeedback`：管理用户反馈  

2. **数据库初始化**：  
   - 进入云开发控制台 → **数据库**  
   - 创建以下集合并设置权限为 **仅创建者可写**：  
     - `activities`（活动数据）  
     - `checkins`（打卡记录）  
     - `users`（用户信息）  
     - `reports`（用户举报记录）  
     - `comments`（评论数据）  
     - `conversations`（聊天会话）  
     - `messages`（聊天消息）  
     - `feedback`（用户反馈）  

3. **存储初始化**：  
   - 进入云开发控制台 → **存储**  
   - 创建以下文件夹：  
     - `avatars`：用户头像  
     - `qrcodes`：活动二维码  
     - `certificates`：证书图片  
     - `chat-images`：聊天图片  


 ## 📱 测试建议  


 ### 1. 创建活动  
 - 首页 → 点击 **创建活动**  
 - 填写名称、描述、选择打卡地点（最多20个）  
 - 生成二维码分享给好友  


 ### 2. 参与打卡  
 - 扫描活动二维码加入  
 - 前往指定地点（500米内）  
 - 点击 **立即打卡**，添加文字/图片记录  


 ### 3. 验证功能  
 - 完成所有打卡点后，检查是否自动生成证书  
 - 测试个人资料编辑功能  
 - 验证多活动并行参与是否正常  


 ## ⚠️ 注意事项  


1. **权限设置**：  
   - 数据库集合权限必须设置为 **仅创建者可写**  
   - 云函数执行权限保持默认设置  
   - 存储权限设置为 **所有用户可读**  


2. **审核规范**：  
   - 小程序内容需符合微信公众平台规范  
   - 避免使用敏感词和违规内容  
   - 测试时使用测试账号，避免影响正式审核  
   - 提交审核前确保所有功能正常运行  


3. **配额管理**：  
   - 腾讯云开发免费额度：  
     - 数据库：5GB 存储空间，10万次/天读写  
     - 存储：5GB 存储空间，10GB/天下载流量  
     - 云函数：10万次/月调用，1GB/月出站流量  
   - 超出配额后会停止服务，需及时调整  


4. **位置权限**：  
   - 小程序需要获取用户地理位置权限  
   - 打卡时会进行500米范围校验  
   - 确保用户授权位置权限后再进行打卡操作  


5. **云开发配置**：  
   - 确保在 `app.js` 中正确配置云开发环境 ID  
   - 所有云函数必须上传并部署成功  
   - 首次使用时需初始化数据库集合  


6. **图片上传**：  
   - 头像和打卡图片会上传到云存储  
   - 建议使用压缩后的图片，避免占用过多存储配额  


7. **二维码生成**：  
   - 活动二维码使用云函数生成  
   - 生成的二维码会存储在云存储中  


 ## 📋 页面结构


- **启动页面** (`pages/splash/splash`)：全屏轨迹录图片，点击开始参与进入首页  
- **首页** (`pages/index/index`)：活动列表展示，搜索和扫码加入  
- **创建活动** (`pages/create/create`)：创建自定义打卡活动  
- **活动详情** (`pages/activity/activity`)：活动信息和打卡状态  
- **打卡** (`pages/checkin/checkin`)：位置校验和打卡提交  
- **个人中心** (`pages/profile/profile`)：用户信息管理  
- **证书生成** (`pages/certificate/certificate`)：生成和分享证书  
- **聊天列表** (`pages/chat-list/chat-list`)：聊天会话列表  
- **聊天详情** (`pages/chat/chat`)：聊天消息发送和接收  
- **管理员中心** (`pages/admin/admin`)：管理员功能入口  
- **用户举报管理** (`pages/admin/user-reports/user-reports`)：处理用户举报  
- **评论管理** (`pages/admin/comment-management/comment-management`)：管理评论  
- **反馈管理** (`pages/admin/feedback-management/feedback-management`)：管理用户反馈  
- **用户反馈** (`pages/feedback/feedback`)：用户提交反馈  


## 🛡️ 违规内容处理


### 实现方式

- **核心模块**：`cloudfunctions/contentModeration/index.js` - 违规内容检测核心模块
- **检测方式**：
  - 敏感词过滤：从数据库读取敏感词列表，支持政治、色情、暴力、违法等类别
  - 正则表达式匹配：从数据库读取规则，检测电话号码、邮箱、QQ号、微信号、URL等个人信息
  - 实时检测：通过云函数在内容提交前进行实时检测

### 应用场景

- **活动创建**：检测活动名称和描述中的违规内容
- **打卡记录**：检测打卡备注中的违规内容
- **评论功能**：检测评论内容中的违规内容
- **聊天消息**：检测聊天消息中的违规内容
- **用户反馈**：检测反馈内容中的违规内容
- **用户信息**：检测用户昵称、签名等信息中的违规内容

### 前端反馈

- 动态错误提示：当检测到违规内容时，显示具体的违规原因
- 实时验证：在用户输入过程中进行初步验证
- 友好提示：使用清晰的错误信息，帮助用户理解违规原因

### 管理员维护

- **初始化违规词**：
  1. 在微信开发者工具中，右键点击 `cloudfunctions/initModeration` 目录
  2. 选择 **上传并部署**，确保云函数已部署到云端
  3. 在云开发控制台中，执行 `initModeration` 云函数，初始化常用违规词列表

- **敏感词管理**：
  1. 进入管理员中心 (`pages/admin/admin`)
  2. 点击 **内容审核** → **敏感词管理**
  3. 可进行以下操作：
     - 添加敏感词：输入敏感词内容并选择分类
     - 编辑敏感词：点击敏感词右侧的编辑按钮进行修改
     - 删除敏感词：点击敏感词右侧的删除按钮进行删除
     - 按分类过滤：选择分类查看对应敏感词
     - 分页查看：支持分页浏览敏感词列表

- **规则管理**：
  1. 进入管理员中心 (`pages/admin/admin`)
  2. 点击 **内容审核** → **审核规则管理**
  3. 可进行以下操作：
     - 添加规则：输入规则名称、正则表达式和描述
     - 编辑规则：点击规则右侧的编辑按钮进行修改
     - 删除规则：点击规则右侧的删除按钮进行删除

- **常用违规词类别**：
  - 政治：政治敏感词、敏感人物、敏感事件等
  - 色情：色情相关词、黄色、淫秽等
  - 暴力：暴力相关词、血腥、杀人等
  - 赌博：赌博相关词、赌场、赌钱等
  - 毒品：毒品相关词、海洛因、冰毒等
  - 广告：广告相关词、推广、宣传等
  - 违法：违法相关词、犯罪、盗窃等
  - 其他：不良信息、垃圾信息、骚扰信息等


## 🎯 技术栈


- **前端**：微信小程序原生框架（WXML, WXSS, JavaScript）  
- **后端**：腾讯云开发（云函数 + 云数据库 + 云存储）  
- **开发工具**：微信开发者工具  
- **核心算法**：Haversine公式（位置距离计算）  
- **违规检测**：关键词过滤 + 正则表达式匹配  


 ## 📞 联系方式  


 如有问题或建议，欢迎反馈！  


 ---  


 **说明**：本项目为个人开发学习使用，如需商用请遵守相关法律法规。